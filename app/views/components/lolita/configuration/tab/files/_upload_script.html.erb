
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/overcast/jquery-ui.css" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/lolita/upload/jquery.ui.plupload.css" type="text/css" />

  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="/javascripts/lolita/upload/plupload.full.min.js"></script>
  <script type="text/javascript" src="/javascripts/lolita/upload/jquery.ui.plupload.min.js"></script>
<% unless Lolita.locale.to_s.downcase=="en" %>
  <script type="text/javascript" src="/javascripts/lolita/upload/I18n/<%=Lolita.locale%>.js"></script>
<% end %>

<script type="text/javascript">  
 $(function(){  
  $("#<%=container%>").plupload({
    // General settings
    runtimes : 'html5,flash',
    url : '<%=send(:"lolita_upload_#{tab.type}_path")%>',
    max_file_size : '10mb',
    chunk_size : '1mb',
    unique_names : true,
    rename: true,
    multipart: true,
    multipart_params: {  
      "authenticity_token" : '<%= form_authenticity_token %>',
      "<%="upload[#{tab.association.name.to_s.singularize}able_type]"%>": "<%=resource.class%>",
      "<%="upload[#{tab.association.name.to_s.singularize}able_id]"%>": "<%=resource.new_record? ? 0 : resource.id%>"
    },
    headers:{
        "X-CSRF-Token": $("meta[name='csrf-token']").attr("content")
    },

    // Flash settings
    flash_swf_url : '/javascripts/lolita/upload/plupload.flash.swf',
    init:{
      FileUploaded:function(uploader, file, info){
        $("#file_list_for_<%=tab.type%>>tbody").append(info.response)

        var ids="<%="#{resource_name}[#{tab.type.to_s.singularize}_ids][]"%>"
        var existing_ids=[]
        $("input.<%=tab.type%>-ids").each(function(){
          existing_ids.push($(this).val())
        })

        var new_ids=[]
        $("#file_list_for_<%=tab.type%> tr[data-<%=tab.type%>-id]").each(function(){
          if($.inArray($(this).attr("data-<%=tab.type%>-id"),existing_ids)<0){
            new_ids.push($(this).attr("data-<%=tab.type%>-id"))
          }
        })
        for(var i in new_ids){
          $("#<%=tab.type%>_form").append('<input type="hidden" class="<%=tab.type%>-ids" name="'+ids+'" value="'+new_ids[i]+'" />')
        }

      }  
    },
    
  });

 });  
</script> 
