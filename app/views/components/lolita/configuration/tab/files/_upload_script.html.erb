
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/overcast/jquery-ui.css" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/lolita/upload/jquery.ui.plupload.css" type="text/css" />

  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="/javascripts/lolita/upload/plupload.full.js"></script>
  <script type="text/javascript" src="/javascripts/lolita/upload/jquery.ui.plupload.js"></script>
<% unless Lolita.locale.to_s.downcase=="en" %>
  <script type="text/javascript" src="/javascripts/lolita/upload/I18n/<%=Lolita.locale%>.js"></script>
<% end %>
<script type="text/javascript">  
 $(function(){  
  $("#<%=container%>").plupload({
    // General settings
    runtimes : 'html5,flash',
    url : '<%=send(:"lolita_upload_#{tab.type}_path")%>',
    max_file_size : '10mb',
    chunk_size : '1mb',
    unique_names : true,
    rename: true,
    <% if tab.extensions.any? %>
      filters:[
        <% tab.extensions.each do |ext_data| %>
          {title: "<%=ext_data[:title]%>", extensions: "<%= ext_data[:extensions].is_a?(Array) ? ext_data[:extensions].join(",") : ext_data[:extensions] %>"},
        <% end %>
      ],
    <% end %>
    multipart: true,
    multipart_params: {  
      "authenticity_token" : '<%= form_authenticity_token %>',
      "upload[fileable_type]": "<%= resource.class %>",
      "upload[fileable_id]": "<%= resource.new_record? ? 0 : resource.id %>",
      "uploader": "<%= tab.uploader %>"
    },
    headers:{
        "X-CSRF-Token": $("meta[name='csrf-token']").attr("content")
    },

    // Flash settings
    flash_swf_url : '/javascripts/lolita/upload/plupload.flash.swf',
    init:{
      FileUploaded:function(uploader, file, info){
        <% if tab.association_type == :many %>
          $("#file_list_for_<%=tab.type%>_<%=tab.uploader%>>tbody").append(info.response)
        <% else %>
          uploader.splice(0,10);
          $("#file_list_for_<%=tab.type%>_<%=tab.uploader%>>tbody").html("")
          $("#file_list_for_<%=tab.type%>_<%=tab.uploader%>>tbody").append(info.response)
        <% end %>

        <% if tab.association_type == :many %>
          var ids="<%="#{resource_name}[#{tab.association.name}_ids][]"%>"
        <% else %>
          var ids = "<%="#{resource_name}[#{tab.association.name}_new]"%>"
        <% end %>

        var existing_ids=[]
        $("input.<%=tab.type%>-ids").each(function(){
          existing_ids.push($(this).val())
        })

        var new_ids=[]
        $("#file_list_for_<%=tab.type%>_<%=tab.uploader%> tr[data-<%=tab.type%>-id]").each(function(){
          if($.inArray($(this).attr("data-<%=tab.type%>-id"),existing_ids)<0){
            new_ids.push($(this).attr("data-<%=tab.type%>-id"))
          }
        })
        for(var i in new_ids){
          $("#<%=tab.type%>_form").append('<input type="hidden" class="<%=tab.type%>-ids" name="'+ids+'" value="'+new_ids[i]+'" />')
        }

      }  
    },
    
  });

 });  
</script> 
